/*
 * Copyright 2020 RISE Research Institutes of Sweden
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *   http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

#include <zoot/suit.h>

int suit_env_unwrap(const uint8_t * pem, 
        const uint8_t * env, const size_t len_env,
        const uint8_t ** man, size_t * len_man)
{
    cose_sign_context_t ctx;
    if (cose_sign_init(&ctx, cose_mode_r, pem)) return 1;

    uint8_t * auth;
    size_t len_auth;

    nanocbor_value_t nc, map, arr;
    nanocbor_decoder_init(&nc, env, len_env);
    if (nanocbor_enter_map(&nc, &map) < 0) return 1;
    while (!nanocbor_at_end(&map)) {
        int32_t map_key;
        if (nanocbor_get_int32(&map, &map_key) < 0) return 1;
        if (map_key == suit_env_auth_wrapper) {
            if (nanocbor_get_bstr(&map, (const uint8_t **) &auth, &len_auth) < 0) 
                return 1;
            else break;
        }
        nanocbor_skip(&map);
    }

    nanocbor_decoder_init(&nc, auth, len_auth);
    if (nanocbor_enter_map(&nc, &arr) < 0) return 1;

    int err = cose_sign1_read(&ctx, arr.cur, arr.end - arr.cur, man, len_man);
    DUMPD(err)

    cose_sign_free(&ctx);
    return err;
}

int suit_env_wrap(const uint8_t * pem,
        const uint8_t * man, const size_t len_man,
        uint8_t * env, size_t * len_env)
{
    /* initialize COSE Sign1 context for authentication wrapper */
    cose_sign_context_t ctx;
    if (cose_sign_init(&ctx, cose_mode_w, pem)) return 1;

    /* hash the manifest and write it to the end of the output buffer */
    mbedtls_md_type_t md_type = MBEDTLS_MD_SHA256;
    const mbedtls_md_info_t * md_info = mbedtls_md_info_from_type(md_type);
    size_t md_size = mbedtls_md_get_size(md_info);
    mbedtls_md(md_info, man, len_man, env + *len_env - md_size);

    /* serialize the authentication wrapper payload in place */
    nanocbor_encoded_t nc;
    nanocbor_encoder_init(&nc, env, len_env);

    /* encode the envelope header (map with up to five elements) */
    nanocbor_encoder_init(&nc, env, len_env);
    nanocbor_fmt_map(&nc, 2);



    cose_sign_free(&ctx);
    return 0;
    
}
